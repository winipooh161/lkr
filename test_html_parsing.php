<?php

require_once 'vendor/autoload.php';

use PhpOffice\PhpWord\PhpWord;
use PhpOffice\PhpWord\Shared\Html;

echo "–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä—Å–∏–Ω–≥–∞ HTML PhpWord (–±–µ–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤)...\n\n";

// –¢–µ—Å—Ç–æ–≤—ã–π HTML –∏–∑ ActFlIpController (—É–ø—Ä–æ—â–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è)
$testHtml = '<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>–ê–∫—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç –§–õ-–ò–ü</title>
    <style>
        body {
            font-family: "DejaVu Sans", "Arial", sans-serif;
            line-height: 1.4;
            font-size: 12pt;
        }
        .header {
            text-align: center;
            font-weight: bold;
            margin-bottom: 20px;
            font-size: 14pt;
        }
        table.border {
            border-collapse: collapse;
            width: 100%;
            margin: 15px 0;
        }
        table.border th, table.border td {
            border: 1px solid black;
            padding: 5px;
        }
    </style>
</head>
<body>
    <div class="header">–ê–ö–¢ –í–´–ü–û–õ–ù–ï–ù–ù–´–• –†–ê–ë–û–¢ ‚Ññ 123</div>
    <p>–≥. –ú–æ—Å–∫–≤–∞                                                         01.01.2024</p>
    
    <p>–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π –ø—Ä–µ–¥–ø—Ä–∏–Ω–∏–º–∞—Ç–µ–ª—å –ò–ü –ò–≤–∞–Ω–æ–≤, –ò–ù–ù 123456789012, –û–ì–†–ù–ò–ü 123456789012345, –∞–¥—Ä–µ—Å: –ú–æ—Å–∫–≤–∞, —É–ª. –¢–µ—Å—Ç–æ–≤–∞—è, –¥. 1, –≤ –¥–∞–ª—å–Ω–µ–π—à–µ–º ¬´–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å¬ª, —Å –æ–¥–Ω–æ–π —Å—Ç–æ—Ä–æ–Ω—ã, –∏</p>
    
    <p>–ü–µ—Ç—Ä–æ–≤ –ü–µ—Ç—Ä –ü–µ—Ç—Ä–æ–≤–∏—á, –ø–∞—Å–ø–æ—Ä—Ç: —Å–µ—Ä–∏—è 1234 ‚Ññ 567890, –≤—ã–¥–∞–Ω –û–í–î –¢–µ—Å—Ç–æ–≤–æ–µ 01.01.2010, –∫–æ–¥ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è 123-456, –≤ –¥–∞–ª—å–Ω–µ–π—à–µ–º ¬´–ó–∞–∫–∞–∑—á–∏–∫¬ª, —Å –¥—Ä—É–≥–æ–π —Å—Ç–æ—Ä–æ–Ω—ã, —Å–æ—Å—Ç–∞–≤–∏–ª–∏ –Ω–∞—Å—Ç–æ—è—â–∏–π –ê–∫—Ç –æ —Ç–æ–º, —á—Ç–æ –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å –≤—ã–ø–æ–ª–Ω–∏–ª —Å–ª–µ–¥—É—é—â–∏–µ —Ä–∞–±–æ—Ç—ã:</p>
    
    <table class="border">
        <tr>
            <th>‚Ññ</th>
            <th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç</th>
            <th>–ï–¥. –∏–∑–º.</th>
            <th>–ö–æ–ª-–≤–æ</th>
            <th>–¶–µ–Ω–∞</th>
            <th>–°—É–º–º–∞</th>
        </tr>
        <tr>
            <td>1</td>
            <td>–ö–æ–º–ø–ª–µ–∫—Å —Ä–µ–º–æ–Ω—Ç–Ω–æ-–æ—Ç–¥–µ–ª–æ—á–Ω—ã—Ö —Ä–∞–±–æ—Ç –ø–æ –∞–¥—Ä–µ—Å—É: –ú–æ—Å–∫–≤–∞, —É–ª. –¢–µ—Å—Ç–æ–≤–∞—è, –¥. 1</td>
            <td>—É—Å–ª.</td>
            <td>1</td>
            <td>50000</td>
            <td>50000</td>
        </tr>
        <tr>
            <td colspan="5" style="text-align: right;"><strong>–ò—Ç–æ–≥–æ:</strong></td>
            <td>50000</td>
        </tr>
    </table>
    
    <p>–í—Å–µ–≥–æ –æ–∫–∞–∑–∞–Ω–æ —É—Å–ª—É–≥ –Ω–∞ —Å—É–º–º—É 50000 (–ø—è—Ç—å–¥–µ—Å—è—Ç —Ç—ã—Å—è—á) —Ä—É–±–ª–µ–π 00 –∫–æ–ø–µ–µ–∫, –ù–î–° –Ω–µ –æ–±–ª–∞–≥–∞–µ—Ç—Å—è.</p>
    
    <table style="width: 100%; margin-top: 50px;">
        <tr>
            <td style="width: 50%; vertical-align: top;">
                <p><b>–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å:</b></p>
                <p>–ò–ü –ò–≤–∞–Ω–æ–≤<br>–ò–ù–ù: 123456789012<br>–û–ì–†–ù–ò–ü: 123456789012345</p>
                <p>_________________________ / –ò–≤–∞–Ω–æ–≤ –ò.–ò. /</p>
            </td>
            <td style="width: 50%; vertical-align: top;">
                <p><b>–ó–∞–∫–∞–∑—á–∏–∫:</b></p>
                <p>–ü–µ—Ç—Ä–æ–≤ –ü–µ—Ç—Ä –ü–µ—Ç—Ä–æ–≤–∏—á<br>–ü–∞—Å–ø–æ—Ä—Ç: 1234 567890</p>
                <p>_________________________ / –ü–µ—Ç—Ä–æ–≤ –ü.–ü. /</p>
            </td>
        </tr>
    </table>
</body>
</html>';

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ DOCTYPE –∏ –æ—Å–Ω–æ–≤–Ω—ã—Ö HTML-—Ç–µ–≥–æ–≤
function minimalCleanHtml($html) {
    // –£–¥–∞–ª—è–µ–º DOCTYPE
    $html = preg_replace('/<!DOCTYPE[^>]*>/i', '', $html);
    
    // –£–¥–∞–ª—è–µ–º —Ç–µ–≥–∏ html, head, body
    $html = preg_replace('/<\/?html[^>]*>/i', '', $html);
    $html = preg_replace('/<\/?head[^>]*>/i', '', $html);
    $html = preg_replace('/<\/?body[^>]*>/i', '', $html);
    
    // –£–¥–∞–ª—è–µ–º meta –∏ title —Ç–µ–≥–∏
    $html = preg_replace('/<meta[^>]*>/i', '', $html);
    $html = preg_replace('/<\/?title[^>]*>/i', '', $html);
    
    // –£–¥–∞–ª—è–µ–º style –∏ script –±–ª–æ–∫–∏
    $html = preg_replace('/<style[^>]*>.*?<\/style>/is', '', $html);
    $html = preg_replace('/<script[^>]*>.*?<\/script>/is', '', $html);
    
    // –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º –Ω–µ—ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∞–º–ø–µ—Ä—Å–∞–Ω–¥—ã
    $html = preg_replace('/&(?![a-zA-Z0-9#]{1,7};)/', '&amp;', $html);
    
    return trim($html);
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ HTML –¥–ª—è PhpWord
function optimizeHtmlForPhpWord($html) {
    // –ë–∞–∑–æ–≤–∞—è –æ—á–∏—Å—Ç–∫–∞
    $html = minimalCleanHtml($html);
    
    // –£–¥–∞–ª—è–µ–º –ø—Ä–æ–±–ª–µ–º–∞—Ç–∏—á–Ω—ã–µ –∞—Ç—Ä–∏–±—É—Ç—ã CSS
    $html = preg_replace('/\s+class="[^"]*"/i', '', $html);
    $html = preg_replace('/\s+style="[^"]*"/i', '', $html);
    $html = preg_replace('/\s+id="[^"]*"/i', '', $html);
    
    // –û–ø—Ç–∏–º–∏–∑–∏—Ä—É–µ–º —Ç–∞–±–ª–∏—Ü—ã - —É–ø—Ä–æ—â–∞–µ–º –∞—Ç—Ä–∏–±—É—Ç—ã
    $html = preg_replace('/<table[^>]*class="border"[^>]*>/', '<table border="1">', $html);
    $html = preg_replace('/<table[^>]*>/', '<table>', $html);
    
    // –ó–∞–º–µ–Ω—è–µ–º div —Å –∫–ª–∞—Å—Å–æ–º header –Ω–∞ h2
    $html = preg_replace('/<div[^>]*class="header"[^>]*>(.*?)<\/div>/is', '<h2>$1</h2>', $html);
    
    // –£–±–∏—Ä–∞–µ–º colspan —Å style - PhpWord –º–æ–∂–µ—Ç –Ω–µ –ø–æ–Ω–∏–º–∞—Ç—å –∫–æ–º–±–∏–Ω–∞—Ü–∏—é
    $html = preg_replace('/<td([^>]*colspan="[^"]*")[^>]*style="[^"]*"([^>]*)>/', '<td$1$2>', $html);
    
    return $html;
}

// –¢–µ—Å—Ç 1: –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π HTML (—Ç–æ–ª—å–∫–æ –ø–∞—Ä—Å–∏–Ω–≥)
echo "=== –¢–ï–°–¢ 1: –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π HTML (—Ç–æ–ª—å–∫–æ –ø–∞—Ä—Å–∏–Ω–≥) ===\n";
try {
    $phpWord = new PhpWord();
    $section = $phpWord->addSection();
    
    Html::addHtml($section, $testHtml);
    
    echo "‚úÖ –£–°–ü–ï–•: –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π HTML —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω\n";
    echo "‚ÑπÔ∏è  –≠–ª–µ–º–µ–Ω—Ç–æ–≤ –≤ —Å–µ–∫—Ü–∏–∏: " . count($section->getElements()) . "\n\n";
    
} catch (Exception $e) {
    echo "‚ùå –û–®–ò–ë–ö–ê: " . $e->getMessage() . "\n\n";
}

// –¢–µ—Å—Ç 2: –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ (—Ç–æ–ª—å–∫–æ –ø–∞—Ä—Å–∏–Ω–≥)
echo "=== –¢–ï–°–¢ 2: –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ HTML (—Ç–æ–ª—å–∫–æ –ø–∞—Ä—Å–∏–Ω–≥) ===\n";
try {
    $cleanHtml = minimalCleanHtml($testHtml);
    echo "–û—á–∏—â–µ–Ω–Ω—ã–π HTML (–ø–µ—Ä–≤—ã–µ 200 —Å–∏–º–≤–æ–ª–æ–≤):\n" . substr($cleanHtml, 0, 200) . "...\n\n";
    
    $phpWord = new PhpWord();
    $section = $phpWord->addSection();
    
    Html::addHtml($section, $cleanHtml);
    
    echo "‚úÖ –£–°–ü–ï–•: HTML —Å –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π –æ—á–∏—Å—Ç–∫–æ–π —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω\n";
    echo "‚ÑπÔ∏è  –≠–ª–µ–º–µ–Ω—Ç–æ–≤ –≤ —Å–µ–∫—Ü–∏–∏: " . count($section->getElements()) . "\n\n";
    
} catch (Exception $e) {
    echo "‚ùå –û–®–ò–ë–ö–ê: " . $e->getMessage() . "\n\n";
}

// –¢–µ—Å—Ç 3: –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π HTML (—Ç–æ–ª—å–∫–æ –ø–∞—Ä—Å–∏–Ω–≥)
echo "=== –¢–ï–°–¢ 3: –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π HTML (—Ç–æ–ª—å–∫–æ –ø–∞—Ä—Å–∏–Ω–≥) ===\n";
try {
    $optimizedHtml = optimizeHtmlForPhpWord($testHtml);
    echo "–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π HTML (–ø–µ—Ä–≤—ã–µ 300 —Å–∏–º–≤–æ–ª–æ–≤):\n" . substr($optimizedHtml, 0, 300) . "...\n\n";
    
    $phpWord = new PhpWord();
    $section = $phpWord->addSection();
    
    Html::addHtml($section, $optimizedHtml);
    
    echo "‚úÖ –£–°–ü–ï–•: –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π HTML —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω\n";
    echo "‚ÑπÔ∏è  –≠–ª–µ–º–µ–Ω—Ç–æ–≤ –≤ —Å–µ–∫—Ü–∏–∏: " . count($section->getElements()) . "\n\n";
    
} catch (Exception $e) {
    echo "‚ùå –û–®–ò–ë–ö–ê: " . $e->getMessage() . "\n\n";
}

// –¢–µ—Å—Ç 4: –ü—Ä–æ—Å—Ç–µ–π—à–∏–π HTML (—Ç–æ–ª—å–∫–æ –ø–∞—Ä—Å–∏–Ω–≥)
echo "=== –¢–ï–°–¢ 4: –ü—Ä–æ—Å—Ç–µ–π—à–∏–π HTML (—Ç–æ–ª—å–∫–æ –ø–∞—Ä—Å–∏–Ω–≥) ===\n";
$simpleHtml = '<h2>–ê–ö–¢ –í–´–ü–û–õ–ù–ï–ù–ù–´–• –†–ê–ë–û–¢ ‚Ññ 123</h2>
<p>–≥. –ú–æ—Å–∫–≤–∞ 01.01.2024</p>
<p>–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π –ø—Ä–µ–¥–ø—Ä–∏–Ω–∏–º–∞—Ç–µ–ª—å –ò–ü –ò–≤–∞–Ω–æ–≤ –≤—ã–ø–æ–ª–Ω–∏–ª —Å–ª–µ–¥—É—é—â–∏–µ —Ä–∞–±–æ—Ç—ã:</p>
<table border="1">
    <tr>
        <th>‚Ññ</th>
        <th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç</th>
        <th>–°—É–º–º–∞</th>
    </tr>
    <tr>
        <td>1</td>
        <td>–ö–æ–º–ø–ª–µ–∫—Å —Ä–µ–º–æ–Ω—Ç–Ω–æ-–æ—Ç–¥–µ–ª–æ—á–Ω—ã—Ö —Ä–∞–±–æ—Ç</td>
        <td>50000</td>
    </tr>
</table>
<p><strong>–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å:</strong> –ò–ü –ò–≤–∞–Ω–æ–≤</p>
<p><strong>–ó–∞–∫–∞–∑—á–∏–∫:</strong> –ü–µ—Ç—Ä–æ–≤ –ü.–ü.</p>';

try {
    $phpWord = new PhpWord();
    $section = $phpWord->addSection();
    
    Html::addHtml($section, $simpleHtml);
    
    echo "‚úÖ –£–°–ü–ï–•: –ü—Ä–æ—Å—Ç–µ–π—à–∏–π HTML —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω\n";
    echo "‚ÑπÔ∏è  –≠–ª–µ–º–µ–Ω—Ç–æ–≤ –≤ —Å–µ–∫—Ü–∏–∏: " . count($section->getElements()) . "\n\n";
    
} catch (Exception $e) {
    echo "‚ùå –û–®–ò–ë–ö–ê: " . $e->getMessage() . "\n\n";
}

echo "–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä—Å–∏–Ω–≥–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!\n";
echo "üìã –†–µ–∑—É–ª—å—Ç–∞—Ç: –í–∏–¥–∏–º, –∫–∞–∫–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã HTML —É—Å–ø–µ—à–Ω–æ –ø–∞—Ä—Å—è—Ç—Å—è\n";
echo "üí° –°–ª–µ–¥—É—é—â–∏–π —à–∞–≥: –ù—É–∂–Ω–æ —Ä–µ—à–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—É —Å ZipArchive –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤\n";
